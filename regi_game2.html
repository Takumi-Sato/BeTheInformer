<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!--<link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">-->
    <title>密告中！</title>
    <style>
    @media screen and (max-width:480px) {
        /*スマホを480px以下と定義してスマホ対応デザインにする*/
        #all {
            width: 80%;
            font-size: 80%;
        }
    }

    @media screen and (min-width:480px) {
        #all {
            margin: 0 auto;
        }
    }
    </style>
</head>

<body>
    <!-- ゲームタイトルロゴ 
    <div class="logo"><h1><img src="02.png"></h1></div>-->
    <!--  -->
    <h1>ユーザー登録</h1>
    <form class="regi" name="regi" method="get">
        <p>ユーザー名：
            <input type="text" class="user_name" name="user_name" size="25">
        </p>
    </form>
    <button class="submit">登録</button>
    <h1>グループの参加者</h1>
    <ul class="group_member"></ul>
    <!-- トップページへのリンク -->
    <a href="BeTheInformer.html">トップに戻る</a>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <script type="text/javascript">
    function getMemberList() {
        $.ajax({
            //url: "http://192.168.1.3:8887/getMemberList",
            url: "https://be-the-informer.herokuapp.com/getMemberList",
            type: "post",
            dataType: "json",
            //data: JSON.stringify(jsonGroupName),
            success: function(res) {
                Display(res);
            },
            error: function(res) {
                console.log("ERROR");
            }
        });
    }
    setInterval(getMemberList, 5000);

    function Display(res) {
        console.log("Display(res) [input] : " + JSON.stringify(res));
        var data = res.members;
        //var data = res.user_names;
        console.log("on Display()");
        console.log(data);
        /*参加者の表示*/
        $(".group_member").empty();
        if (data.length == 0) {
            var dom = $("<li>参加者を待っています</li>");
            $(".group_member").append(dom);
        } else {
            for (var i = 0; i < data.length; i++) {
                var member = data[i];
                var dom = $("<li>" + member + "</li>");
                $(".group_member").append(dom);
            }
        }
    }

    $(".submit").on("click", doSubmit);

    function doSubmit() {
        if (formCheck() == 1) {
            window.alert("入力が足りていません。");
        } else {
            var user_name = document.forms.regi.user_name.value;
            localStorage.user_name = user_name; //ローカルストレージに保存しておく(ユーザー名)
            var data = $('form').serializeArray();
            console.log(parseJson(data));
            //location.href = "wait_host.html";

            /* ！！！！！！！！！！！！！！送信するよ！！！！！！！！！！！！！！ */
            var json = parseJson(data);
            $.ajax({
                url: 'https://be-the-informer.herokuapp.com/regHostPlayerAndStartGame',
                type: 'post',
                dataType: 'json',
                contentType: 'application/json',
                scriptCharset: 'utf-8',
                data: JSON.stringify(json),
                success: function(res) {
                    console.log("regHostPlayerAndStartGame return: " + JSON.stringify(res));
                    if (res.player_regi_success) {
                        location.href = "playing.html";
                    } else {
                        // #TODO: 同名プレイヤーが既に存在することを通知する
                    }
                },
                error: function(res) {
                    console.log("ERROR");
                }
            })
        }
    }

    function formCheck() {
        var flag = 0;
        /* ユーザー名が入力されていないとき */
        if (document.forms.regi.user_name.value == "") {
            flag = 1;
        }
        return flag;
    }

    var parseJson = function(data) {
        var returnJson = {};
        for (idx = 0; idx < data.length; idx++) {
            returnJson[data[idx].name] = data[idx].value
        }
        //console.log(idx);
        return returnJson;
    }
    </script>
</body>

</html>